<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
        <div><input type="file" id="fileselect" multiple/></div>
        <div>암호키 <input type="text" id="filekey" value="124"/></div>
        <br>
        <div id="logdiv"></div>
        <script>
            fileselect.onchange=()=>{
                const key=Number(filekey.value);
                logdiv.innerText=`키: 0x${key.toString(16).padStart(2,'0')} (${key})\n\n`;
                const files=fileselect.files;
                for(let i=0;i<files.length;i++){
                    const file=files[i];
                    const reader=new FileReader();
                    reader.onload=()=>{
                        const buf=new Uint8Array(reader.result);
                        for(let i=buf.length;i>=0;i--){
                            buf[i]^=key;
                        }
                        const blob = new Blob([], { type: file.type });
                        logdiv.innerText+=`${file.name}\n`;
                        uint8ArrayToDataURL(buf,file.type).then(x=>download(x,file.name));
                    };
                    reader.readAsArrayBuffer(file);
                }
            };
            function download(url,name) {
                const a = document.createElement('a')
                a.href = url
                a.download = name;
                document.body.appendChild(a)
                a.click()
                document.body.removeChild(a)
            }

            function uint8ArrayToDataURL(uint8Array, mimeType) {
                return new Promise((resolve, reject) => {
                    const blob = new Blob([uint8Array], { type: mimeType });
                    const reader = new FileReader();

                    reader.onload = function() {
                    resolve(reader.result);
                    };

                    reader.onerror = function(error) {
                    reject(error);
                    };

                    reader.readAsDataURL(blob);
                });
            }
        </script>
    </body>
</html>